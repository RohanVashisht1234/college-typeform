<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Workflow Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --accent: #3b82f6;
            --surface: #fff;
            --gray: #f8f9fa;
            --text: #222;
            --border: #e5e7eb;
            --surface-dark: #191c1e;
            --surface-dark2: #202427;
            --gray-dark: #181b1e;
            --border-dark: #32363a;
            --text-dark: #f3f4f6;
            --text-dark2: #b5bec9;
            --accent-dark: #06b6d4;
        }

        html,
        body {
            height: 100%;
            min-height: 100vh;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--gray);
            color: var(--text);
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background .2s, color .2s;
        }

        body.dark,
        .dark body {
            background: var(--gray-dark) !important;
            color: var(--text-dark2);
        }

        .dark,
        .dark * {
            --text: var(--text-dark2);
            color: var(--text-dark2) !important;
        }

        .top-nav {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background .2s, border .2s;
        }

        .dark .top-nav {
            background: var(--surface-dark);
            border-color: var(--border-dark);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #6b7280;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb-item span {
            cursor: pointer;
        }

        .nav-tabs {
            display: flex;
            gap: 24px;
            margin: 0 auto;
        }

        .nav-tab {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: #111827;
            border-bottom-color: var(--primary);
        }

        .nav-tab:hover {
            color: #374151;
        }

        .dark .nav-tab {
            color: var(--text-dark2);
        }

        .dark .nav-tab.active {
            color: #fff;
            border-bottom-color: var(--primary);
        }

        .dark .nav-tab:hover {
            color: #fff;
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #d1d5db;
            background: var(--surface);
            color: #374151;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            border-color: #9ca3af;
        }

        .btn-primary {
            background: var(--primary);
            color: white !important;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .dark .top-actions .btn,
        .dark .btn {
            background: var(--surface-dark2);
            color: var(--text-dark2) !important;
            border-color: var(--border-dark);
        }

        .dark .btn-primary {
            background: var(--primary);
            color: #fff !important;
            border-color: var(--primary);
        }

        .dark .btn-primary:hover {
            background: var(--primary-dark);
        }

        .secondary-nav {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dark .secondary-nav {
            background: var(--surface-dark);
            border-color: var(--border-dark);
        }

        .workflow-tabs {
            display: flex;
            gap: 24px;
        }

        .workflow-tab {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .workflow-tab.active {
            color: #111827;
            font-weight: 600;
        }

        .workflow-tab:hover {
            color: #374151;
        }

        .dark .workflow-tab {
            color: var(--text-dark2);
        }

        .dark .workflow-tab.active {
            color: #fff;
        }

        .dark .workflow-tab:hover {
            color: #fff;
        }

        .workflow-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            color: #374151;
            background: #f3f4f6;
        }

        .dark .action-btn {
            color: var(--text-dark2);
        }

        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .left-sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 20px;
        }

        .dark .left-sidebar {
            background: var(--surface-dark2);
            border-color: var(--border-dark);
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .sidebar-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .sidebar-content {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
        }

        .add-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid #d1d5db;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .dark .add-btn {
            background: var(--surface-dark2);
            border-color: var(--border-dark);
        }

        .workflow-canvas {
            flex: 1;
            overflow: auto;
            padding: 40px;
            position: relative;
            background-color: var(--gray);
        }

        .dark .workflow-canvas {
            background-color: var(--gray-dark);
        }

        .workflow-container {
            position: relative;
            min-height: 100%;
        }

        .workflow-node {
            position: absolute;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            width: 240px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
            cursor: move;
            user-select: none;
            z-index: 10;
        }

        .dark .workflow-node {
            background: var(--surface-dark2);
            border-color: var(--border-dark);
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .node-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .node-icon.chart {
            background: #10b981;
        }

        .node-icon.circle {
            background: #8b5cf6;
        }

        .node-icon.phone {
            background: #ef4444;
        }

        .node-icon.check {
            background: #3b82f6;
        }

        .node-number {
            font-size: 12px;
            font-weight: 600;
            color: #111827;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .dark .node-number {
            color: #fff;
            background: #282c34;
        }

        .node-title {
            font-size: 14px;
            font-weight: 500;
            color: #111827;
            margin-bottom: 8px;
        }

        .dark .node-title {
            color: #fff;
        }

        .node-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .node-option {
            font-size: 12px;
            color: #6b7280;
            padding: 4px 8px;
            border-radius: 4px;
            background: #f3f4f6;
        }

        .dark .node-option {
            background: #23272b;
            color: #b5bec9;
        }

        .node-connector {
            position: absolute;
            width: 24px;
            height: 24px;
            background: #374151;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            cursor: pointer;
            z-index: 20;
            border: 2px solid #fff;
        }

        .node-connector.right {
            top: 50%;
            right: -14px;
            transform: translateY(-50%);
        }

        .node-connector.left {
            top: 50%;
            left: -14px;
            transform: translateY(-50%) rotate(180deg);
        }

        .connection-line {
            position: absolute;
            background: #3b82f6;
            height: 3px;
            z-index: 5;
            border-radius: 2px;
        }

        .connection-line::after {
            content: '';
            position: absolute;
            right: 0;
            top: -5px;
            width: 0;
            height: 0;
            border-top: 7px solid transparent;
            border-bottom: 7px solid transparent;
            border-left: 10px solid #3b82f6;
        }

        .right-sidebar {
            width: 320px;
            background: var(--surface);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            padding: 20px;
        }

        .dark .right-sidebar {
            background: var(--surface-dark2);
            border-color: var(--border-dark);
        }

        .integration-section {
            margin-bottom: 32px;
        }

        .integration-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .integration-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 16px;
        }

        .integration-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }

        .integration-content {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
        }

        .integration-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .integration-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .integration-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .bottom-bar {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .dark .bottom-bar {
            background: var(--surface-dark);
            border-color: var(--border-dark);
        }

        .bottom-action {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 16px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .bottom-action:hover {
            color: #374151;
            background: #f3f4f6;
        }

        .dark .bottom-action {
            color: var(--text-dark2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .dark .modal-content {
            background: var(--surface-dark2);
            color: #fff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: var(--surface);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        @media (max-width: 1200px) {
            .right-sidebar {
                width: 280px;
            }
        }

        @media (max-width: 992px) {
            .left-sidebar {
                width: 240px;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }

            .left-sidebar,
            .right-sidebar {
                width: 100%;
                border: none;
                border-bottom: 1px solid #e5e7eb;
            }

            .workflow-canvas {
                padding: 20px;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #333;
        }
    </style>
</head>

<body>
    <nav class="top-nav">
        <div class="breadcrumb">
            <div class="breadcrumb-item" onclick="gotoWorkspace()" style="cursor:pointer;">
                <i class="fas fa-th"></i><span>My workspace</span><i class="fas fa-chevron-right"></i>
            </div>
            <div class="breadcrumb-item"><span id="breadcrumbFormName"></span></div>
        </div>
        <div class="nav-tabs">
            <div class="nav-tab" onclick="gotoContent()">Content</div>
            <div class="nav-tab active" onclick="gotoWorkflow()">Workflow</div>
            <div class="nav-tab" onclick="gotoConnect()">Connect</div>
            <div class="nav-tab" onclick="gotoShare()">Share</div>
            <div class="nav-tab" onclick="gotoResults()">Results</div>
        </div>
        <div class="top-actions">
            <button class="btn" id="linkBtn"><i class="fas fa-link"></i></button>
            <button class="btn btn-primary" id="plansBtn">View plans</button>
            <button class="btn" id="helpBtn"><i class="fas fa-question-circle"></i></button>
            <div class="user-avatar">RV</div>
            <button class="btn" id="darkToggleBtn" title="Toggle dark mode" style="margin-left:8px;"><i
                    class="fas fa-moon"></i></button>
        </div>
    </nav>
    <div class="secondary-nav">
        <div class="workflow-tabs">
            <div class="workflow-tab active" onclick="showTab('branching')">Branching</div>
            <div class="workflow-tab" onclick="showTab('scoring')">Scoring</div>
            <div class="workflow-tab" onclick="showTab('outcome')">Outcome quiz</div>
        </div>
        <div class="workflow-actions">
            <button class="action-btn" title="Preview" id="previewBtn"><i class="fas fa-play"></i></button>
            <button class="action-btn" title="Settings" id="settingsBtn"><i class="fas fa-cog"></i></button>
            <div style="margin-left: 16px; font-size: 14px; font-weight: 500;">Actions</div>
        </div>
    </div>
    <div class="main-layout">
        <aside class="left-sidebar">
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <div class="sidebar-icon"><i class="fas fa-arrow-down"></i></div>
                    <div class="sidebar-title">Pull data in</div>
                </div>
                <div class="sidebar-content">Track sources, identify respondents, and personalize the form content and
                    flow with URL parameters.</div>
                <div style="margin-top:16px;text-align:center;">
                    <button class="add-btn" onclick="openModal()"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </aside>
        <main class="workflow-canvas" id="workflowCanvas">
            <div class="workflow-container" id="workflowContainer"></div>
            <div id="mockWorkflowTab" style="margin-top:40px;"></div>
        </main>
        <aside class="right-sidebar">
            <div class="integration-section">
                <div class="integration-header">
                    <div class="integration-icon"><i class="fas fa-th"></i></div>
                    <div class="integration-title">Connect</div>
                </div>
                <div class="integration-buttons">
                    <button class="integration-btn"><i class="fas fa-file-alt"></i></button>
                    <button class="integration-btn"><i class="fas fa-table"></i></button>
                    <button class="integration-btn"><i class="fas fa-minus"></i></button>
                    <button class="integration-btn"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="integration-section">
                <div class="integration-header">
                    <div class="integration-icon"><i class="fas fa-envelope"></i></div>
                    <div class="integration-title">Messages</div>
                </div>
                <div class="integration-buttons">
                    <button class="integration-btn"><i class="fas fa-file-alt"></i></button>
                    <button class="integration-btn"><i class="fas fa-puzzle-piece"></i></button>
                    <button class="integration-btn"><i class="fas fa-envelope"></i></button>
                    <button class="integration-btn"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="integration-section">
                <div class="integration-header">
                    <div class="integration-icon"><i class="fas fa-link"></i></div>
                    <div class="integration-title">Webhooks</div>
                </div>
                <div class="integration-content">Connect with any app to send responses or trigger actions.</div>
                <div style="margin-top:16px;text-align:center;">
                    <button class="add-btn"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </aside>
    </div>
    <div class="bottom-bar">
        <button class="bottom-action"><i class="fas fa-search"></i></button>
        <button class="bottom-action"><i class="fas fa-search-plus"></i></button>
        <button class="bottom-action"><i class="fas fa-expand"></i></button>
        <button class="bottom-action"><i class="fas fa-history"></i></button>
        <div style="margin-left:auto;font-size:12px;color:#6b7280;" id="bottomUrl"></div>
    </div>
    <div class="modal" id="addNodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Question Node</h2>
                <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="addNodeForm">
                <div class="form-group"><label class="form-label" for="nodeTitle">Question Title</label>
                    <input type="text" class="form-input" id="nodeTitle" placeholder="Enter question title" required>
                </div>
                <div class="form-group"><label class="form-label" for="nodeType">Question Type</label>
                    <select class="form-select" id="nodeType">
                        <option value="rating">Rating Scale</option>
                        <option value="yesno">Yes/No</option>
                        <option value="text">Text Input</option>
                        <option value="multiple">Multiple Choice</option>
                    </select>
                </div>
                <div class="modal-actions"><button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Node</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        let nodes = [];
        let connections = [];
        let draggedNode = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let isConnecting = false;
        let connectingFrom = null;
        let zoomLevel = 1;
        let formName = (new URL(window.location.href)).searchParams.get('q') || 'Untitled Form';
        document.getElementById('breadcrumbFormName').textContent = formName;
        let forms = JSON.parse(localStorage.getItem('forms') || '[]');
        let form = forms.find(f => (f.name || f.title) === formName);
        if (!form) { form = { name: formName, questions: [] }; forms.push(form); localStorage.setItem('forms', JSON.stringify(forms)); }
        function iconClass(type, title) { if (type === 'rating') return 'chart'; if (type === 'phone') return 'phone'; if (type === 'text' && title && title.toLowerCase().includes('thanks')) return 'check'; if (type === 'yesno') return 'check'; if (type === 'multiple') return 'circle'; return 'circle'; }
        function clearWorkflow() { nodes = []; connections = []; let container = document.getElementById('workflowContainer'); while (container.firstChild) container.removeChild(container.firstChild); }
        function drawWorkflow() {
            clearWorkflow();
            let qlist = form.questions || [];
            let gapX = 340, gapY = 190;
            // Build nodes
            qlist.forEach((q, i) => {
                let x = 100 + i * gapX, y = 100;
                if (q.nodePos) { x = q.nodePos.x; y = q.nodePos.y; }
                let opts = [];
                if (q.type === 'rating') opts = ['1', '2', '3', '4', '5'];
                if (q.type === 'yesno') opts = ['Yes', 'No'];
                if (q.type === 'multiple') opts = q.options || ['Option 1', 'Option 2'];
                let node = { id: i + 1, type: q.type, title: q.title || 'Untitled', options: opts, x: x, y: y, nodePos: { x: x, y: y } };
                nodes.push(node);
            });
            nodes.forEach(n => {
                let nodeEl = document.createElement('div');
                nodeEl.className = 'workflow-node';
                nodeEl.id = 'node-' + n.id;
                nodeEl.style.left = n.x + 'px';
                nodeEl.style.top = n.y + 'px';
                let ic = iconClass(n.type, n.title);
                nodeEl.innerHTML = `
      <div class="node-header">
        <div class="node-icon ${ic}">
          ${ic === 'chart' ? '<i class="fas fa-chart-bar"></i>' : ic === 'phone' ? '<i class="fas fa-phone"></i>' : ic === 'check' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-circle"></i>'}
        </div>
        <div class="node-number">${n.id}</div>
      </div>
      <div class="node-title" contenteditable="true" spellcheck="false">${n.title}</div>
      <div class="node-options">${n.options.map(o => `<div class="node-option">${o}</div>`).join('')}</div>
      <div class="node-connector right" data-node-id="${n.id}"><i class="fas fa-arrow-right"></i></div>
      <div class="node-connector left" data-node-id="${n.id}" style="${n.id === 1 ? 'display:none;' : ''}"><i class="fas fa-arrow-left"></i></div>
    `;
                nodeEl.addEventListener('mousedown', startDragNode);
                nodeEl.querySelector('.node-title').onblur = function () {
                    n.title = this.textContent;
                    let qidx = n.id - 1;
                    if (form.questions[qidx]) form.questions[qidx].title = this.textContent;
                    saveWorkflow(); drawWorkflow();
                };
                nodeEl.querySelector('.node-title').setAttribute('placeholder', 'Question title');
                nodeEl.querySelector('.node-connector.right').addEventListener('mousedown', startConnectionArrow);
                nodeEl.querySelector('.node-connector.left').addEventListener('mouseup', endConnectionArrow);
                n.element = nodeEl;
                document.getElementById('workflowContainer').appendChild(nodeEl);
            });
            // Draw connections
            nodes.forEach((n, i) => {
                let q = form.questions[i]; let fromIdx = null;
                if (q.branchIf !== undefined && q.branchIf !== '' && q.branchIf !== null) { fromIdx = parseInt(q.branchIf); }
                else if (i > 0) { fromIdx = i - 1; }
                if (fromIdx !== null && fromIdx !== i) {
                    let fromNode = nodes[fromIdx]; let toNode = nodes[i];
                    if (fromNode && toNode) {
                        let fromX = fromNode.x + 240, fromY = fromNode.y + 60;
                        let toX = toNode.x, toY = toNode.y + 60;
                        let width = toX - fromX;
                        let line = document.createElement('div');
                        line.className = 'connection-line';
                        line.style.left = fromX + 'px';
                        line.style.top = fromY + 'px';
                        line.style.width = Math.max(30, width) + 'px';
                        line.style.height = '3px';
                        document.getElementById('workflowContainer').appendChild(line);
                        connections.push({ from: fromNode.id, to: toNode.id, element: line });
                    }
                }
            });
        }
        function startDragNode(e) {
            if (e.target.closest('.node-connector')) return;
            let nodeEl = e.currentTarget;
            let nodeId = parseInt(nodeEl.id.split('-')[1]);
            let node = nodes.find(n => n.id === nodeId);
            if (!node) return;
            draggedNode = node;
            let rect = nodeEl.getBoundingClientRect();
            let containerRect = document.getElementById('workflowContainer').getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
            document.addEventListener('mousemove', dragNodeMove);
            document.addEventListener('mouseup', stopDragNode);
            e.preventDefault();
        }
        function dragNodeMove(e) {
            if (!draggedNode) return;
            let container = document.getElementById('workflowContainer');
            let containerRect = container.getBoundingClientRect();
            let newX = (e.clientX - containerRect.left - dragOffsetX) / zoomLevel;
            let newY = (e.clientY - containerRect.top - dragOffsetY) / zoomLevel;
            draggedNode.x = newX; draggedNode.y = newY;
            draggedNode.nodePos = { x: newX, y: newY };
            draggedNode.element.style.left = `${newX}px`; draggedNode.element.style.top = `${newY}px`;
            if (form.questions[draggedNode.id - 1]) form.questions[draggedNode.id - 1].nodePos = { x: newX, y: newY };
            saveWorkflow(); drawWorkflow();
        }
        function stopDragNode() { draggedNode = null; document.removeEventListener('mousemove', dragNodeMove); document.removeEventListener('mouseup', stopDragNode); }
        let arrowLine = null; let arrowFromNode = null;
        function startConnectionArrow(e) {
            e.stopPropagation();
            isConnecting = true;
            let nodeId = parseInt(e.currentTarget.dataset.nodeId);
            arrowFromNode = nodes.find(n => n.id === nodeId);
            arrowLine = document.createElement('div');
            arrowLine.className = 'connection-line';
            arrowLine.id = 'temp-arrow';
            document.getElementById('workflowContainer').appendChild(arrowLine);
            document.addEventListener('mousemove', moveArrowLine);
            document.addEventListener('mouseup', cancelArrowLine);
        }
        function moveArrowLine(e) {
            if (!isConnecting || !arrowLine || !arrowFromNode) return;
            let container = document.getElementById('workflowContainer');
            let containerRect = container.getBoundingClientRect();
            let fromX = arrowFromNode.x + 240, fromY = arrowFromNode.y + 60;
            let toX = (e.clientX - containerRect.left) / zoomLevel, toY = (e.clientY - containerRect.top) / zoomLevel;
            let width = toX - fromX;
            arrowLine.style.left = fromX + 'px';
            arrowLine.style.top = fromY + 'px';
            arrowLine.style.width = Math.max(30, width) + 'px';
            arrowLine.style.height = '3px';
        }
        function endConnectionArrow(e) {
            if (!isConnecting || !arrowFromNode) return;
            let nodeId = parseInt(e.currentTarget.dataset.nodeId);
            let toNode = nodes.find(n => n.id === nodeId);
            if (toNode && arrowFromNode.id !== toNode.id) {
                let idx = toNode.id - 1;
                if (form.questions[idx]) {
                    form.questions[idx].branchIf = arrowFromNode.id - 1;
                    saveWorkflow(); drawWorkflow();
                }
            }
            cleanupArrowLine();
        }
        function cancelArrowLine() { cleanupArrowLine(); }
        function cleanupArrowLine() {
            isConnecting = false; arrowFromNode = null;
            if (arrowLine) { arrowLine.remove(); arrowLine = null; }
            document.removeEventListener('mousemove', moveArrowLine);
            document.removeEventListener('mouseup', cancelArrowLine);
        }
        function openModal() { document.getElementById('addNodeModal').classList.add('active'); }
        function closeModal() { document.getElementById('addNodeModal').classList.remove('active'); document.getElementById('addNodeForm').reset(); }
        function addNewNode(e) {
            e.preventDefault();
            const title = document.getElementById('nodeTitle').value || 'Untitled';
            const type = document.getElementById('nodeType').value;
            let opts = [];
            if (type === 'rating') { opts = ['1', '2', '3', '4', '5']; }
            else if (type === 'yesno') { opts = ['Yes', 'No']; }
            else if (type === 'multiple') { opts = ['Option 1', 'Option 2', 'Option 3']; }
            let last = nodes[nodes.length - 1];
            let x = last ? last.x + 340 : 100, y = last ? last.y : 100;
            let q = { type: type, title: title, options: opts, nodePos: { x: x, y: y } };
            form.questions.push(q);
            saveWorkflow(); closeModal(); drawWorkflow(); showNotification('Node added successfully!');
        }
        function saveWorkflow() {
            let idx = forms.findIndex(f => (f.name || f.title) === formName);
            if (idx !== -1) { forms[idx] = form; } localStorage.setItem('forms', JSON.stringify(forms));
        }
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = { success: '#10b981', warning: '#f59e0b', error: '#ef4444', info: '#3b82f6' };
            notification.style.cssText = `position:fixed;top:20px;right:20px;background:${colors[type]};color:white;padding:12px 20px;border-radius:8px;font-size:14px;font-weight:500;z-index:2000;box-shadow:0 4px 12px rgba(16,185,129,0.3);transform:translateX(100%);transition:transform 0.3s ease;`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.transform = 'translateX(0)'; }, 100);
            setTimeout(() => { notification.style.transform = 'translateX(100%)'; setTimeout(() => { if (document.body.contains(notification)) { document.body.removeChild(notification); } }, 300); }, 3000);
        }
        function gotoWorkspace() { window.location = '/logged_in/index.html'; }
        function gotoContent() { window.location = '/logged_in/content.html?q=' + encodeURIComponent(formName); }
        function gotoConnect() { window.location = '/logged_in/connect.html?q=' + encodeURIComponent(formName); }
        function gotoShare() { window.location = '/logged_in/share.html?q=' + encodeURIComponent(formName); }
        function gotoResults() { window.location = '/logged_in/results.html?q=' + encodeURIComponent(formName); }
        document.getElementById('addNodeForm').addEventListener('submit', addNewNode);
        document.addEventListener('DOMContentLoaded', () => {
            drawWorkflow();
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            document.getElementById('addNodeModal').addEventListener('click', function (e) { if (e.target === this) closeModal(); });
            document.querySelector('.add-btn').addEventListener('click', openModal);

            // Top bar actions
            document.getElementById('plansBtn').onclick = () => window.location = '/pricing.html';
            document.getElementById('linkBtn').onclick = copyFormLink;
            document.getElementById('helpBtn').onclick = () => window.location = '/help.html';
            document.getElementById('darkToggleBtn').onclick = toggleDarkMode;
            document.getElementById('previewBtn').onclick = () => window.open('/logged_in/export.html?q=' + encodeURIComponent(formName), '_blank');
            document.getElementById('settingsBtn').onclick = gotoContent;

            // Sample link at bottom
            document.getElementById('bottomUrl').innerText = window.location.origin + '/logged_in/export.html?q=' + encodeURIComponent(formName);

            // Dark mode initialize
            setDarkInitial();

            // Section tabs
            showTab('branching');
        });
        function copyFormLink() {
            const url = window.location.origin + '/logged_in/export.html?q=' + encodeURIComponent(formName);
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('Form link copied!', 'success');
                });
            } else {
                const tmp = document.createElement('input');
                tmp.value = url;
                document.body.appendChild(tmp);
                tmp.select();
                document.execCommand('copy');
                tmp.remove();
                showNotification('Form link copied!', 'success');
            }
        }
        // D A R K  M O D E
        function setDarkInitial() {
            let dark = false;
            if (localStorage.getItem('workflow-darkmode') === '1') dark = true;
            else if (localStorage.getItem('workflow-darkmode') === '0') dark = false;
            else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) dark = true;
            if (dark) {
                document.body.classList.add('dark');
                document.getElementById('darkToggleBtn').innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark');
                document.getElementById('darkToggleBtn').innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            if (document.body.classList.contains('dark')) {
                localStorage.setItem('workflow-darkmode', '1');
                document.getElementById('darkToggleBtn').innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                localStorage.setItem('workflow-darkmode', '0');
                document.getElementById('darkToggleBtn').innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        function showTab(tab) {
            let mock = document.getElementById('mockWorkflowTab');
            let html = '';
            if (tab === 'branching') {
                html = `<h3 style="color:var(--primary);margin-bottom:12px;font-size:1.1em;">Branching logic preview</h3>
      <ul style="margin-bottom:18px;padding-left:20px;">
        <li>If Q1 is "No", skip to Q4.</li>
        <li>If Q2 is "5", show outcome "A".</li>
        <li>If Q3 is "Yes", jump to end of form.</li>
      </ul>
      <div style="color:#6b7280;">This is a visual mockup. Drag nodes, connect arrows, and play to preview the flow.</div>`;
            } else if (tab === 'scoring') {
                html = `<h3 style="color:var(--primary-dark);margin-bottom:12px;font-size:1.1em;">Scoring mock</h3>
      <ul style="margin-bottom:18px;padding-left:20px;">
        <li>Q1: Yes = 10 pts, No = 0 pts</li>
        <li>Q2: Rating scale, each point = 2 pts</li>
        <li>Q3: "Fast" = 5 pts, "Slow" = 1 pt</li>
      </ul>
      <div style="color:#6b7280;">Assign points to answers and customize quiz scoring (demo only).</div>`;
            } else if (tab === 'outcome') {
                html = `<h3 style="color:var(--accent);margin-bottom:12px;font-size:1.1em;">Outcome quiz mock</h3>
      <ul style="margin-bottom:18px;padding-left:20px;">
        <li>If score ≥ 20, outcome: "Expert"</li>
        <li>If score 10-19, outcome: "Intermediate"</li>
        <li>If score &lt; 10, outcome: "Beginner"</li>
      </ul>
      <div style="color:#6b7280;">Set up outcomes based on total score (demo only).</div>`;
            }
            mock.innerHTML = html;
        }
    </script>
</body>

</html>